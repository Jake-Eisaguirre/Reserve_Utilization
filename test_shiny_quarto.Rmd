---
title: "Flight Attendant Reserve Utilization"
subtitle: "Crew Resource Planning"
format: 
  html:
    self-contained: true
    grid:
      body-width: 1400px
      sidebar-width: 175px
      gutter-width: 1.0em
editor: source
theme: pulse
title-block-banner: "#41369"
last-modified:
date: "`r Sys.Date()`"
date-format: "YYYY-MM-DD"
server: shiny  # Enable shiny
css: style.css
#page-layout: custom
---

## Data Background
Data presented in this report is aggregated across the `CT_MASTER_HISTORY` table from the Snowflake Database within the `CREW ANALYTICS` Schema. For the purpose of this report, reserve utilization is defined as an employee having an `RLV` code and receiving an `ASN` code for a given day. The `RLV` head count per day is determined by the count of distinct employees per day on the 25th of the preceding bid period; This is prior to when FAs can trade RLV days. The black dashed line presented on the first figure indicates the average utilization for the given bid period. For the sick code figure and data; sick codes are defined as `SOP`, `2SK`, `FLV`, `FLP`, `UNA`, `FLS`, `FLU`, `N/S`, `PER`, `MGR`. The sick code figure visualizes the final sick code associated with the employee following an assignment determined by the greatest value associated for Update Date and Time column per day per employee. The sick code table provides all the sicks codes within the transaction following the assignment.      
  

## Daily RLV Utilization

```{r}
#| context: setup
#| message: false
#| warning: false
#| results: false

 
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

# librarian downloads, if not already downloaded, and reads in needed packages
librarian::shelf(tidyverse, here, DBI, odbc, scales, padr, DT, plotly, shiny, ggplot2, lubridate)

raw_date <- Sys.Date()

#bid_period_remove <- substr(as.character((raw_date + 30)), 1, 7) 

tryCatch({
    db_connection <- DBI::dbConnect(odbc::odbc(),
                             Driver="SnowflakeDSIIDriver",
                             Server="hawaiianair.west-us-2.azure.snowflakecomputing.com",
                             WAREHOUSE="DATA_LAKE_READER",
                             Database="ENTERPRISE",
                             UID= "jacob.eisaguirre@hawaiianair.com", 
                             authenticator = "externalbrowser")
    print("Database Connected!")
    },
    error=function(cond) {
            print("Unable to connect to Database.")
})




# Set search_path
dbExecute(db_connection, "USE SCHEMA CREW_ANALYTICS")


q_master_history <- paste0("select * from CT_MASTER_HISTORY;")


master_history_raw <- dbGetQuery(db_connection, q_master_history) %>% 
  mutate(UPDATE_TIME = as.character(UPDATE_DATE),
         UPDATE_TIME = as.character(UPDATE_TIME)) 


q_bid_periods <- "select distinct BID_PERIOD from CT_MASTER_HISTORY order by BID_PERIOD DESC;"

bid_periods <- dbGetQuery(db_connection, q_bid_periods)

bases <- c("HNL", "LAX")



```


```{r}
#| panel: sidebar

selectInput("bid_periods_input", "Bid Period", bid_periods$BID_PERIOD)

selectInput("bases", "Base", bases)


```

::: {.panel-tabset}

## Reserve Utilization
```{r}
#| panel: center

plotlyOutput('plot_utl', height = "600px", width = "1000px")


```



## Sick After ASN
```{r}
#| panel: center

plotlyOutput('plotly_sic',  height = "400px", width = "900px")

dataTableOutput('asn_table')

```


:::

```{r}
#| context: server


####################### Reserve utilization ######################################

reserve_utl <- reactive({
  
  update_dt_rlv <- paste0((as_datetime(paste0(input$bid_periods_input, "-25 00:00:00"))-2592000),  "-25 00:00:00") 
  
  fa_ut_rlv <- master_history_raw %>% 
  ungroup() %>% 
  filter(CREW_INDICATOR == "FA",
         BID_PERIOD == input$bid_periods_input) %>% 
  filter(TRANSACTION_CODE %in% c("ACR", "RSV", "RLV", "ASN", "BSN", "BRD")) %>%
  mutate(update_dt = paste(UPDATE_DATE, UPDATE_TIME, sep = " ")) %>%
  filter(update_dt < update_dt_rlv) %>%
  group_by(CREW_ID, PAIRING_DATE, TRANSACTION_CODE) %>%
  mutate(temp_id = cur_group_id()) %>%
  filter(!duplicated(temp_id)) %>%
  ungroup() %>% 
  select(CREW_INDICATOR, CREW_ID, TRANSACTION_CODE, PAIRING_NO,
         PAIRING_DATE, TO_DATE, PAIRING_POSITION, BID_PERIOD, BASE, update_dt)


fa_ut_asn <- master_history_raw %>% 
  ungroup() %>% 
  filter(CREW_INDICATOR == "FA",
         BID_PERIOD == input$bid_periods_input) %>% 
  filter(TRANSACTION_CODE %in% c("ACR", "RSV", "RLV", "ASN", "BSN", "BRD")) %>% 
  mutate(update_dt = paste(UPDATE_DATE, UPDATE_TIME, sep = " ")) %>%
  group_by(CREW_ID, PAIRING_DATE, TRANSACTION_CODE) %>%
  mutate(temp_id = cur_group_id()) %>%
  filter(!duplicated(temp_id)) %>%
  ungroup() %>% 
  select(CREW_INDICATOR, CREW_ID, TRANSACTION_CODE, PAIRING_NO,
         PAIRING_DATE, TO_DATE, PAIRING_POSITION, BID_PERIOD, BASE, update_dt)

fa_ut_single <- fa_ut_asn %>% 
  group_by(CREW_ID, PAIRING_NO) %>% 
  mutate(single = if_else(PAIRING_DATE == TO_DATE, 1, 0)) %>% 
  filter(single == 1) %>% 
  filter(TRANSACTION_CODE %in% c("ASN", "BSN", "BRD")) %>% 
  pivot_longer(cols = c("PAIRING_DATE", "TO_DATE"),
               values_to = "DATE") %>% 
  group_by(CREW_ID, TRANSACTION_CODE, DATE, PAIRING_NO) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id)) %>%
  ungroup() 

fa_ut_double <- fa_ut_asn %>% 
  group_by(CREW_ID, PAIRING_NO) %>% 
  mutate(single = if_else(PAIRING_DATE == TO_DATE, 1, 0)) %>% 
  filter(single == 0) %>% 
  filter(TRANSACTION_CODE %in% c("ASN", "BSN", "BRD")) %>% 
  pivot_longer(cols = c("PAIRING_DATE", "TO_DATE"),
               values_to = "DATE") %>% 
  group_by(CREW_ID, TRANSACTION_CODE, DATE, PAIRING_NO) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id)) %>%
  ungroup() %>% 
  group_by(CREW_ID, BASE, PAIRING_NO) %>% 
  pad() %>% 
  ungroup() 

piv_emp_hist_fa_asn <- rbind(fa_ut_double, fa_ut_single) %>% 
  group_by(DATE, BASE) %>% 
  mutate(rlv_used = n()) %>% 
  ungroup() %>% 
  select(DATE, BASE, rlv_used)


piv_emp_hist_fa_rlv <- fa_ut_rlv %>% 
  mutate(update_dt = as_datetime(update_dt)) %>% 
  filter(TRANSACTION_CODE %in% c("RLV")) %>%
  rename(DATE = PAIRING_DATE) %>% 
  group_by(DATE, BASE) %>% 
  mutate(net_rlv_available = length(unique(CREW_ID))) %>% 
  ungroup() %>% 
  select(DATE, BASE, net_rlv_available)


comb_fa <- left_join(piv_emp_hist_fa_rlv, piv_emp_hist_fa_asn, relationship = "many-to-many",
                      by = join_by(DATE, BASE)) %>% 
  group_by(DATE, BASE) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id)) %>% 
  select(!temp_id) %>%
  ungroup() %>% 
  mutate(rlv_used = if_else(is.na(rlv_used), 0, rlv_used)) %>% 
  mutate(rlv_remaining = net_rlv_available - rlv_used)%>% 
  #mutate(rlv_remaining = if_else(rlv_remaining < 0,0, rlv_remaining)) %>% 
  mutate(perc_ut = round((rlv_used/net_rlv_available)*100, 0)) %>% 
  group_by(BASE) %>% 
  mutate(m_avg_utl = round(mean(rlv_used), 0))


comb_fa_hnl <- comb_fa %>%
  filter(BASE == input$bases)

})


long_data_fa_hnl_rec <- reactive({
  
  reserve_utl() %>%
  select(DATE, BASE, rlv_used, rlv_remaining) %>%
  pivot_longer(cols = c(rlv_used, rlv_remaining), 
               names_to = "rlv_type", 
               values_to = "Head_Count") %>% 
  filter(BASE == input$bases) %>% 
  mutate(rlv_type=if_else(rlv_type == "rlv_remaining", "RLV Available", "RLV Utilized"))

  
})
  
  

label_data_hnl_rec <- reactive({

 reserve_utl() %>%
  select(DATE, BASE, net_rlv_available)%>% 
  filter(BASE == input$bases)
  
  
})



label_data_hnl_used_rec <- reactive({

 reserve_utl() %>%
  select(DATE, BASE, rlv_used)%>% 
  filter(BASE == input$bases)
  
})


hline_reac <- reactive({
  
data.frame(
  yintercept = reserve_utl()$m_avg_utl)
  
})


output$plot_utl <- renderPlotly({
  
  # Create the ggplot object
 utl_p <- ggplot(reserve_utl()) +
    geom_bar(aes(x = DATE, y = net_rlv_available,
                 text = paste("Date:", DATE, "<br>RLV Available:", net_rlv_available)), 
             stat = "identity", alpha = 0.3) +
    geom_bar(data = long_data_fa_hnl_rec(), 
             aes(x = DATE, y = Head_Count, fill = rlv_type, 
                 text = paste0("Date:", DATE, "<br>", rlv_type, ": ", Head_Count)), 
             stat = "identity", position = "stack") +
    scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "3 days") +
    scale_fill_manual(values = c("RLV Available" = "#413691", 
                                 "RLV Utilized" = "#D2058A")) +
    labs(x = "Date", y = "Primary RLV Head Count", fill = "RLV Type") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.text = element_text(size = 6),  # Adjust legend text size
          legend.key.size = unit(0.35, "cm"),  # Adjust size of legend keys
          legend.title = element_text(size = 5),  # Adjust legend title size
          legend.box.spacing = unit(0.25, "cm"),  # Adjust spacing around the legend box
          plot.title = element_text(hjust = 1.5)) +  # Center the title
    ggtitle(paste(input$bases)) +
    geom_text(data = label_data_hnl_rec(),
              aes(x = DATE, y = net_rlv_available  + (0.025 * max(net_rlv_available)), label = net_rlv_available),
              size = 2.25, vjust = -0.75, hjust = 0.5) +
    geom_text(data = label_data_hnl_used_rec(),
              aes(x = DATE, y = (rlv_used + (0.025 * max(rlv_used))), label = rlv_used),
              size = 2.25, vjust = -0.75, hjust = 0.5, color = "white") +
    geom_hline(data = hline_reac(), aes(yintercept = yintercept), linetype = "dashed", color = "black") +
    geom_text(data = reserve_utl(), aes(x = max(DATE) + 1.25, y =  + (1.05 * max(m_avg_utl)), label = m_avg_utl), 
              vjust = -1, hjust = 0, color = "black") +
    coord_cartesian(ylim = c(0, NA))
  
 ggplotly(utl_p, tooltip = "text")

  }
)


####################### END Reserve utilization ######################################



####################### Sick After ASN ######################################
fa_trx_hist_rec <- reactive({
  
  master_history_raw %>% 
  filter(CREW_INDICATOR == "FA",
         BID_PERIOD == input$bid_periods_input,
         BASE == input$bases) %>% 
  mutate(update_dt = paste(UPDATE_DATE, UPDATE_TIME, sep = " ")) %>% 
  group_by(CREW_ID, PAIRING_DATE, TRANSACTION_CODE) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id)) %>% 
  select(!temp_id) %>% 
  ungroup() %>% 
  group_by(CREW_ID, PAIRING_DATE) %>% 
  mutate(keep = ifelse(any(TRANSACTION_CODE %in% c("SCR", "ASN", "RSV", "ARC", "RLV")), 1, 0)) %>% 
  filter(keep == 1)

  
})

sick_follow_asn_rec <- reactive({
  
  fa_trx_hist_rec() %>% 
  group_by(CREW_ID, PAIRING_DATE) %>% 
  mutate(keep = if_else(any(TRANSACTION_CODE %in% c("SOP", "2SK", "FLV", "FLP", "UNA", "FLS", "FLU",
                                                    "N/S", "PER", "MGR")), 1, 0)) %>% 
  filter(keep == 1)

  
}) 


sum_fa_rsk_sop_rec <- reactive({
  
  sick_follow_asn_rec() %>% 
  group_by(CREW_ID, PAIRING_DATE) %>% 
  mutate(keep = if_else(any(TRANSACTION_CODE %in% c("ASN")), 1, 0)) %>%
  filter(keep == 1,
         TRANSACTION_CODE %in% c("SOP", "2SK", "FLV", "FLP", "UNA", "FLS", "FLU",
                                                    "N/S", "PER", "MGR")) %>% 
  dplyr::arrange(CREW_ID, PAIRING_DATE, update_dt) %>% 
  filter(update_dt == max(update_dt)) %>% 
  group_by(PAIRING_POSITION, BASE, PAIRING_DATE, TRANSACTION_CODE) %>% 
  summarise(rlv_asn_2sk = if_else(TRANSACTION_CODE == "2SK", length(unique(CREW_ID)), NA),
         rlv_asn_sop = if_else(TRANSACTION_CODE == "SOP", length(unique(CREW_ID)), NA),
         rlv_asn_flv = if_else(TRANSACTION_CODE == "FLV", length(unique(CREW_ID)), NA),
         rlv_asn_flp = if_else(TRANSACTION_CODE == "FLP", length(unique(CREW_ID)), NA),
         rlv_asn_una = if_else(TRANSACTION_CODE == "UNA", length(unique(CREW_ID)), NA),
         rlv_asn_fls = if_else(TRANSACTION_CODE == "FLS", length(unique(CREW_ID)), NA),
         rlv_asn_flu = if_else(TRANSACTION_CODE == "FLU", length(unique(CREW_ID)), NA),
         rlv_asn_ns = if_else(TRANSACTION_CODE == "N/S", length(unique(CREW_ID)), NA),
         rlv_asn_per = if_else(TRANSACTION_CODE == "PER", length(unique(CREW_ID)), NA),
         rlv_asn_mgr = if_else(TRANSACTION_CODE == "MGR", length(unique(CREW_ID)), NA)) %>% 
  ungroup() %>% 
  select(PAIRING_POSITION, BASE, rlv_asn_2sk, rlv_asn_sop, PAIRING_DATE, rlv_asn_flv, rlv_asn_flp,
         rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr )  %>% 
  group_by(PAIRING_POSITION, BASE, rlv_asn_2sk, rlv_asn_sop, PAIRING_DATE) %>% 
  # mutate(temp_id = cur_group_id()) %>% 
  # filter(!duplicated(temp_id)) %>% 
  # select(!temp_id) %>% 
  ungroup()

  
}) 


# Reshape data to long format
long_data_deg_fa_hnl_rec <- reactive({

  sum_fa_rsk_sop_rec() %>%
  select(PAIRING_DATE, BASE, rlv_asn_2sk, rlv_asn_sop, rlv_asn_flv, rlv_asn_flp,
         rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr) %>%
  pivot_longer(cols = c(rlv_asn_2sk, rlv_asn_sop, rlv_asn_flv, rlv_asn_flp,
         rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr), 
               names_to = "sick_type", 
               values_to = "Head_Count") %>% 
  drop_na(Head_Count) %>% 
  mutate(sick_type=case_when(sick_type == "rlv_asn_2sk" ~ "2SK",
                             sick_type == "rlv_asn_sop" ~ "SOP",
                             sick_type == "rlv_asn_flv" ~ "FLV",
                             sick_type == "rlv_asn_flp" ~ "FLP",
                             sick_type == "rlv_asn_una" ~ "UNA",
                             sick_type == "rlv_asn_fls" ~ "FLS",
                             sick_type == "rlv_asn_flu" ~ "FLU",
                             sick_type == "rlv_asn_ns" ~ "N/S",
                             sick_type == "rlv_asn_per" ~ "PER",
                             sick_type == "rlv_asn_mgr" ~ "MGR")) %>% 
  group_by(PAIRING_DATE, BASE, sick_type) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id))
  
  
}) 



label_data_fa_rsk_hnl_rec <- reactive({
  
  sum_fa_rsk_sop_rec() %>%
  ungroup() %>% 
  select(PAIRING_DATE, BASE, rlv_asn_2sk, rlv_asn_sop, rlv_asn_flv, rlv_asn_flp,
         rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr) %>% 
  group_by(PAIRING_DATE, BASE) %>% 
  mutate(sum_codes = sum(rlv_asn_2sk, rlv_asn_sop, rlv_asn_flv, rlv_asn_flp,
         rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr, na.rm = T))

  
}) 

label_data_fa_sop_hnl_rec <- reactive({
  
  sum_fa_rsk_sop_rec() %>%
  ungroup() %>% 
  select(PAIRING_DATE, BASE, rlv_asn_sop) %>% 
  drop_na(rlv_asn_sop) 

  
}) 

custom_colors_rec  <- reactive({
  
  c(colorRampPalette(c("#413691", "#D2058A"))(length(unique(long_data_deg_fa_hnl_rec()$sick_type))))
  
}) 


output$plotly_sic <- renderPlotly({

 code_p <- ggplot(sum_fa_rsk_sop_rec()) +
  geom_bar(data = long_data_deg_fa_hnl_rec(), 
           aes(x = PAIRING_DATE, y = Head_Count, fill = sick_type), 
           stat = "identity", position = "stack") +
  scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "3 days") +
  scale_fill_manual(values = custom_colors_rec(), name = "RLV Sick Type") +
  labs(x = "Date", y = "Primary Head Count", fill = "RLV Sick Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(size = 6),  # Adjust legend text size
        legend.key.size = unit(0.25, "cm"),  # Adjust size of legend keys
        legend.title = element_text(size = 5),  # Adjust legend title size
        legend.box.spacing = unit(0.25, "cm"),
        plot.title = element_text(hjust = 0.5)# Adjust spacing around the legend box
        ) +
  ggtitle(paste(input$bases)) 

  ggplotly(code_p)
    
})




####################### END Sick After ASN ######################################


```


```{r}
#| echo: false

# 
# fa_ut_rlv <- master_history_raw %>% 
#   ungroup() %>% 
#   filter(CREW_INDICATOR == "FA") %>% 
#   filter(TRANSACTION_CODE %in% c("ACR", "RSV", "RLV", "ASN", "BSN", "BRD")) %>%
#   mutate(update_dt = paste(UPDATE_DATE, UPDATE_TIME, sep = " ")) %>%
#   filter(update_dt < update_dt_rlv) %>%
#   group_by(CREW_ID, PAIRING_DATE, TRANSACTION_CODE) %>%
#   mutate(temp_id = cur_group_id()) %>%
#   filter(!duplicated(temp_id)) %>%
#   ungroup() %>% 
#   select(CREW_INDICATOR, CREW_ID, TRANSACTION_CODE, PAIRING_NO,
#          PAIRING_DATE, TO_DATE, PAIRING_POSITION, BID_PERIOD, BASE, update_dt)
# 
# 
# fa_ut_asn <- master_history_raw %>% 
#   ungroup() %>% 
#   filter(CREW_INDICATOR == "FA") %>% 
#   filter(TRANSACTION_CODE %in% c("ACR", "RSV", "RLV", "ASN", "BSN", "BRD")) %>% 
#   mutate(update_dt = paste(UPDATE_DATE, UPDATE_TIME, sep = " ")) %>%
#   group_by(CREW_ID, PAIRING_DATE, TRANSACTION_CODE) %>%
#   mutate(temp_id = cur_group_id()) %>%
#   filter(!duplicated(temp_id)) %>%
#   ungroup() %>% 
#   select(CREW_INDICATOR, CREW_ID, TRANSACTION_CODE, PAIRING_NO,
#          PAIRING_DATE, TO_DATE, PAIRING_POSITION, BID_PERIOD, BASE, update_dt)
# 
# 

```


```{r}
#| echo: false
#| message: false
#| warning: false
#| results: false

# fa_ut_single <- fa_ut_asn %>% 
#   group_by(CREW_ID, PAIRING_NO) %>% 
#   mutate(single = if_else(PAIRING_DATE == TO_DATE, 1, 0)) %>% 
#   filter(single == 1) %>% 
#   filter(TRANSACTION_CODE %in% c("ASN", "BSN", "BRD")) %>% 
#   pivot_longer(cols = c("PAIRING_DATE", "TO_DATE"),
#                values_to = "DATE") %>% 
#   group_by(CREW_ID, TRANSACTION_CODE, DATE, PAIRING_NO) %>% 
#   mutate(temp_id = cur_group_id()) %>% 
#   filter(!duplicated(temp_id)) %>%
#   ungroup() 
# 
# fa_ut_double <- fa_ut_asn %>% 
#   group_by(CREW_ID, PAIRING_NO) %>% 
#   mutate(single = if_else(PAIRING_DATE == TO_DATE, 1, 0)) %>% 
#   filter(single == 0) %>% 
#   filter(TRANSACTION_CODE %in% c("ASN", "BSN", "BRD")) %>% 
#   pivot_longer(cols = c("PAIRING_DATE", "TO_DATE"),
#                values_to = "DATE") %>% 
#   group_by(CREW_ID, TRANSACTION_CODE, DATE, PAIRING_NO) %>% 
#   mutate(temp_id = cur_group_id()) %>% 
#   filter(!duplicated(temp_id)) %>%
#   ungroup() %>% 
#   group_by(CREW_ID, BASE, PAIRING_NO) %>% 
#   pad() %>% 
#   ungroup() 
# 
# piv_emp_hist_fa_asn <- rbind(fa_ut_double, fa_ut_single) %>% 
#   group_by(DATE, BASE) %>% 
#   mutate(rlv_used = n()) %>% 
#   ungroup() %>% 
#   select(DATE, BASE, rlv_used)
# 
# # piv_emp_hist_fa_asn <- fa_ut_asn %>% 
# #   filter(TRANSACTION_CODE %in% c("ASN", "BSN", "BRD")) %>% 
# #   pivot_longer(cols = c("PAIRING_DATE", "TO_DATE"),
# #                values_to = "DATE") %>% 
# #   group_by(CREW_ID, TRANSACTION_CODE, DATE, PAIRING_NO) %>% 
# #   mutate(temp_id = cur_group_id()) %>% 
# #   filter(!duplicated(temp_id)) %>%
# #   ungroup() %>% 
# #   group_by(CREW_ID, BASE, PAIRING_NO) %>% 
# #   pad() %>% 
# #   ungroup() %>% 
# #   group_by(DATE, BASE) %>% 
# #   mutate(rlv_used = n()) %>% 
# #   ungroup() %>% 
# #   select(DATE, BASE, rlv_used)
# 
# 
# piv_emp_hist_fa_rlv <- fa_ut_rlv %>% 
#   mutate(update_dt = as_datetime(update_dt)) %>% 
#   filter(TRANSACTION_CODE %in% c("RLV")) %>%
#   rename(DATE = PAIRING_DATE) %>% 
#   #filter(!DATE == "2024-08-01") %>% 
#   group_by(DATE, BASE) %>% 
#   mutate(net_rlv_available = length(unique(CREW_ID))) %>% 
#   ungroup() %>% 
#   select(DATE, BASE, net_rlv_available)
# 
# 
# comb_fa <- left_join(piv_emp_hist_fa_rlv, piv_emp_hist_fa_asn, relationship = "many-to-many",
#                       by = join_by(DATE, BASE)) %>% 
#   group_by(DATE, BASE) %>% 
#   mutate(temp_id = cur_group_id()) %>% 
#   filter(!duplicated(temp_id)) %>% 
#   select(!temp_id) %>%
#   ungroup() %>% 
#   mutate(rlv_used = if_else(is.na(rlv_used), 0, rlv_used)) %>% 
#   mutate(rlv_remaining = net_rlv_available - rlv_used)%>% 
#   mutate(rlv_remaining = if_else(rlv_remaining < 0,0, rlv_remaining)) %>% 
#   mutate(perc_ut = round((rlv_used/net_rlv_available)*100, 0)) %>% 
#   group_by(BASE) %>% 
#   mutate(m_avg_utl = round(mean(rlv_used), 0))
```


```{r}
#| echo: false
#| message: false
#| warning: false
#| results: false
### Connect to `PLAYGROUND` Database
# tryCatch({
#     db_connection_pg <- DBI::dbConnect(odbc::odbc(),
#                              Driver="SnowflakeDSIIDriver",
#                              Server="hawaiianair.west-us-2.azure.snowflakecomputing.com",
#                              WAREHOUSE="DATA_LAKE_READER",
#                              Database="PLAYGROUND",
#                              UID= Sys.getenv("UID"), 
#                              authenticator = "externalbrowser")
#     print("Database Connected!")
#     },
#     error=function(cond) {
#             print("Unable to connect to Database.")
# })
# 
# 
# # Set search_path
# dbExecute(db_connection_pg, "USE SCHEMA CREW_ANALYTICS")
# 
# q_final_pairing <- paste0("select CREW_ID, PAIRING_NO, PAIRING_DATE, FLIGHT_DATE, EQUIPMENT, PAIRING_POSITION,
#                     DEPARTING_CITY, ARRIVAL_CITY, SCHED_DEPARTURE_TIME, SCHED_ARRIVAL_TIME, BID_PERIOD
#                     from AA_FINAL_PAIRING WHERE BID_PERIOD ='", previous_bid_period,"';")
# 
# final_pairing_raw <- dbGetQuery(db_connection_pg, q_final_pairing) 
# 

```



```{r}
#| echo: false
#| message: false
#| warning: false
#| results: false



# 
# 
# # emp_sick_hist_fa <-  sick_follow_asn %>% 
# #   anti_join(final_pairing_raw, by = c("CREW_ID", "PAIRING_DATE", "PAIRING_NO", "PAIRING_POSITION")) %>% 
# #   select(!keep) %>% 
# #   group_by(CREW_ID, PAIRING_DATE) %>% 
# #   mutate(keep = if_else(any(TRANSACTION_CODE %in% c("ASN")), 1, 0)) %>%
# #   filter(keep == 1)
# 
# 



```

## HNL Base

``` {r}
#| echo: false
#| message: false
#| warning: false


# 
# # Base ggplot with hover-specific text for both DATE and RLV values
# p_fnl <- ggplot(comb_fa_hnl) +
#   geom_bar(aes(x = DATE, y = net_rlv_available,
#                text = paste("Date:", DATE, "<br>RLV Available:", net_rlv_available)), 
#            stat = "identity", alpha = 0.3) +
#   geom_bar(data = long_data_fa_hnl, 
#            aes(x = DATE, y = Head_Count, fill = rlv_type, 
#                text = paste0("Date:", DATE, "<br>", rlv_type, ": ", Head_Count)), 
#            stat = "identity", position = "stack") +
#   scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "3 days") +
#   scale_fill_manual(values = c(  
#                                 "RLV Available" = "#413691", 
#                                 "RLV Utilized" = "#D2058A")) +
#   labs(x = "Date", y = "Primary RLV Head Count", fill = "RLV Type") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1),
#         legend.text = element_text(size = 6),  # Adjust legend text size
#         legend.key.size = unit(0.25, "cm"),  # Adjust size of legend keys
#         legend.title = element_text(size = 5),  # Adjust legend title size
#         legend.box.spacing = unit(0.25, "cm"),  # Adjust spacing around the legend box
#         plot.title = element_text(hjust = 0.5)) +  # Center the title
#   ggtitle("HNL")+
#   geom_text(data = label_data_hnl,
#             aes(x = DATE, y = net_rlv_available+5, label = net_rlv_available),
#             size = 1.9, vjust = -0.75, hjust = 0.5) +
#   geom_text(data = label_data_hnl_used,
#             aes(x = DATE, y = (rlv_used-15), label = rlv_used),
#             size = 1.9, vjust = -0.75, hjust = 0.5, color = "white") +
#   geom_hline(data = hline_data_hnl, aes(yintercept = yintercept), linetype = "dashed", color = "black") +
#   geom_text(data = comb_fa_hnl, aes(x = max(DATE)+1.25, y = (m_avg_utl+5), label = m_avg_utl), 
#             vjust = -1, hjust = 0, color = "black")
# 
# 
# ggplotly(p_fnl, tooltip = "text")

```

$~$



$~$

**Sick Codes:** SOP, 2SK, FLV, FLP, UNA, FLS, FLU, N/S, PER, MGR.  

The final sick code associated with the employee following an assignment based on the Update Date and Time column.
```{r}
#| echo: false

# 
# s_hnl <- ggplot(sum_fa_rsk_sop_hnl) +
#   geom_bar(data = long_data_deg_fa_hnl, 
#            aes(x = PAIRING_DATE, y = Head_Count, fill = sick_type), 
#            stat = "identity", position = "stack") +
#   scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "3 days") +
#   scale_fill_manual(values = custom_colors, name = "RLV Sick Type") +
#   labs(x = "Date", y = "Primary Head Count", fill = "RLV Sick Type") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1),
#         legend.text = element_text(size = 6),  # Adjust legend text size
#         legend.key.size = unit(0.25, "cm"),  # Adjust size of legend keys
#         legend.title = element_text(size = 5),  # Adjust legend title size
#         legend.box.spacing = unit(0.25, "cm"),
#         plot.title = element_text(hjust = 0.5)# Adjust spacing around the legend box
#         ) +
#   ggtitle("HNL") 
# 
# 
# plotly_shnl <- ggplotly(s_hnl)
```

$~$

#### Table of RLV FA Recieved Assignment and then Called Out Sick
```{r}
#| echo: false

# sum_fa_rsk_sop_t_hnl <- sick_follow_asn %>% 
#   filter(BASE == "HNL") %>% 
#   group_by(CREW_ID, PAIRING_DATE) %>% 
#   mutate(keep = if_else(any(TRANSACTION_CODE %in% c("ASN")), 1, 0)) %>%
#   filter(keep == 1) %>% 
#   filter(TRANSACTION_CODE %in% c("ASN", "2SK", "SOP", "FLV", "FLP", "UNA", "FLS", "FLU",
#                                                     "N/S", "PER", "MGR")) %>% 
#   select(CREW_ID, TRANSACTION_CODE, PAIRING_DATE, update_dt) %>% 
#   arrange(PAIRING_DATE, CREW_ID, update_dt) %>% 
#   rename(UPDATE_DATE_TIME = update_dt)
# 
# sum_fa_rsk_sop_t_hnl %>% 
#   datatable()
  
```


## LAX Base

``` {r}
#| echo: false
#| message: false
#| warning: false

# # Filter and prepare data for LAX
# comb_fa_lax <- comb_fa %>%
#   filter(BASE == "LAX")
# 
# # Reshape data to long format
# long_data_fa_lax <- comb_fa %>%
#   select(DATE, BASE, rlv_used, rlv_remaining) %>%
#   pivot_longer(cols = c(rlv_used, rlv_remaining), 
#                names_to = "rlv_type", 
#                values_to = "Head_Count") %>% 
#   filter(BASE == "LAX") %>% 
#   mutate(rlv_type = if_else(rlv_type == "rlv_remaining", "RLV Available", "RLV Utilized"))
# 
# # Data for text labels
# label_data_lax <- comb_fa %>%
#   select(DATE, BASE, net_rlv_available) %>%
#   filter(BASE == "LAX")
# 
# label_data_lax_used <- comb_fa %>%
#   select(DATE, BASE, rlv_used) %>%
#   filter(BASE == "LAX")
# 
# # Hline data
# hline_data_lax <- data.frame(
#   yintercept = comb_fa_lax$m_avg_utl
# )
# 
# # Base ggplot with hover-specific text for both DATE and RLV values
# p_fnl_lax <- ggplot(comb_fa_lax) +
#   geom_bar(aes(x = DATE, y = net_rlv_available,
#                text = paste("Date:", DATE, "<br>RLV Available:", net_rlv_available)), 
#            stat = "identity", alpha = 0.3) +
#   geom_bar(data = long_data_fa_lax, 
#            aes(x = DATE, y = Head_Count, fill = rlv_type, 
#                text = paste0("Date:", DATE, "<br>", rlv_type, ": ", Head_Count)), 
#            stat = "identity", position = "stack") +
#   scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "3 days") +
#   scale_fill_manual(values = c(  
#                                 "RLV Available" = "#413691", 
#                                 "RLV Utilized" = "#D2058A")) +
#   labs(x = "Date", y = "Primary RLV Head Count", fill = "RLV Type") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1),
#         legend.text = element_text(size = 6),  # Adjust legend text size
#         legend.key.size = unit(0.25, "cm"),  # Adjust size of legend keys
#         legend.title = element_text(size = 5),  # Adjust legend title size
#         legend.box.spacing = unit(0.25, "cm"),  # Adjust spacing around the legend box
#         plot.title = element_text(hjust = 0.5)) +  # Center the title
#   ggtitle("LAX") +
#   geom_text(data = label_data_lax,
#             aes(x = DATE, y = net_rlv_available+0.5, label = net_rlv_available),
#             size = 1.9, vjust = -0.75, hjust = 0.5) +
#   geom_text(data = label_data_lax_used,
#             aes(x = DATE, y = (rlv_used - 0.5), label = rlv_used),
#             size = 1.9, vjust = -0.75, hjust = 0.5, color = "white") +
#   geom_hline(data = hline_data_lax, aes(yintercept = yintercept), linetype = "dashed", color = "black") +
#   geom_text(data = comb_fa_lax, aes(x = max(DATE) + 1, y = (m_avg_utl + 1), label = m_avg_utl), 
#             vjust = -1, hjust = 0, color = "black")
# 
# # Convert to plotly
# ggplotly(p_fnl_lax, tooltip = "text")

```

$~$



$~$

**Sick Codes:** SOP, 2SK, FLV, FLP, UNA, FLS, FLU, N/S, PER, MGR.  

The final sick code associated with the employee following an assignment based on the Update Date and Time column.
```{r}
#| echo: false
# Filter data for LAX
# sum_fa_rsk_sop_lax <- sum_fa_rsk_sop %>% 
#   filter(BASE == "LAX")
# 
# # Reshape data to long format
# long_data_deg_fa_lax <- sum_fa_rsk_sop_lax %>%
#   select(PAIRING_DATE, BASE, rlv_asn_2sk, rlv_asn_sop, rlv_asn_flv, rlv_asn_flp,
#          rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr) %>%
#   pivot_longer(cols = c(rlv_asn_2sk, rlv_asn_sop, rlv_asn_flv, rlv_asn_flp,
#          rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr), 
#                names_to = "sick_type", 
#                values_to = "Head_Count") %>% 
#   drop_na(Head_Count) %>% 
#   mutate(sick_type=case_when(sick_type == "rlv_asn_2sk" ~ "2SK",
#                              sick_type == "rlv_asn_sop" ~ "SOP",
#                              sick_type == "rlv_asn_flv" ~ "FLV",
#                              sick_type == "rlv_asn_flp" ~ "FLP",
#                              sick_type == "rlv_asn_una" ~ "UNA",
#                              sick_type == "rlv_asn_fls" ~ "FLS",
#                              sick_type == "rlv_asn_flu" ~ "FLU",
#                              sick_type == "rlv_asn_ns" ~ "N/S",
#                              sick_type == "rlv_asn_per" ~ "PER",
#                              sick_type == "rlv_asn_mgr" ~ "MGR"))%>% 
#   group_by(PAIRING_DATE, BASE, sick_type) %>% 
#   mutate(temp_id = cur_group_id()) %>% 
#   filter(!duplicated(temp_id))
# 
# 
# # Create label data for LAX
# label_data_fa_rsk_lax <- sum_fa_rsk_sop_lax %>%
#   ungroup() %>% 
#   select(PAIRING_DATE, BASE, rlv_asn_2sk, rlv_asn_sop, rlv_asn_flv, rlv_asn_flp,
#          rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr) %>% 
#   group_by(PAIRING_DATE, BASE) %>% 
#   mutate(sum_codes = sum(rlv_asn_2sk, rlv_asn_sop, rlv_asn_flv, rlv_asn_flp,
#                          rlv_asn_una, rlv_asn_fls, rlv_asn_flu, rlv_asn_ns, rlv_asn_per, rlv_asn_mgr, na.rm = T))
# 
# # Define a custom color palette, similar to the HNL chart
# custom_colors_lax <- c(
#   colorRampPalette(c("#413691", "#D2058A"))(length(unique(long_data_deg_fa_lax$sick_type)))
# )
# 
# # Create the LAX plot
# s_lax <- ggplot(sum_fa_rsk_sop_lax) +
#   geom_bar(data = long_data_deg_fa_lax, 
#            aes(x = PAIRING_DATE, y = Head_Count, fill = sick_type), 
#            stat = "identity", position = "stack") +
#   scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "3 days") +
#   scale_fill_manual(values = custom_colors_lax, name = "RLV Sick Type") +
#   labs(x = "Date", y = "Primary Head Count", fill = "RLV Sick Type") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1),
#         legend.text = element_text(size = 6),  # Adjust legend text size
#         legend.key.size = unit(0.25, "cm"),  # Adjust size of legend keys
#         legend.title = element_text(size = 5),  # Adjust legend title size
#         legend.box.spacing = unit(0.25, "cm"),
#         plot.title = element_text(hjust = 0.5)) +  # Center the title
#   ggtitle("LAX") 
# 
# # +
# #   geom_text(data = label_data_fa_rsk_lax,
# #             aes(x = PAIRING_DATE, y = sum_codes + 0.05, label = sum_codes),
# #             size = 1.9, vjust = -0.75, hjust = 0.5)
# 
# # Optionally, convert to an interactive plot with ggplotly
# ggplotly(s_lax)
# 
# 

```

$~$

#### Table of RLV FA Recieved Assignment and then Called Out Sick
```{r}
#| echo: false

# sum_fa_rsk_sop_t_lax <- sick_follow_asn %>% 
#   filter(BASE == "LAX") %>% 
#   group_by(CREW_ID, PAIRING_DATE) %>% 
#   mutate(keep = if_else(any(TRANSACTION_CODE %in% c("ASN")), 1, 0)) %>%
#   filter(keep == 1) %>% 
#   filter(TRANSACTION_CODE %in% c("ASN", "2SK", "SOP", "FLV", "FLP", "UNA", "FLS", "FLU",
#                                                     "N/S", "PER", "MGR")) %>% 
#   select(CREW_ID, TRANSACTION_CODE, PAIRING_DATE, update_dt) %>% 
#   arrange(PAIRING_DATE, CREW_ID, update_dt) %>% 
#   rename(UPDATE_DATE_TIME = update_dt)
# 
# sum_fa_rsk_sop_t_lax %>% 
#   datatable()
  
```




